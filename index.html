<!DOCTYPE html>
<html lang="ko">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>글쓰기 나침반</title>
   <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
   <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
   <link href="style.css" rel="stylesheet">
</head>
<body>
    <body class="bg-gray-50">
       <div class="container mx-auto px-4">
       <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-6 no-print">
           <div class="title-container">
               <h1 class="main-title">글쓰기 나침반</h1>
               <p class="subtitle">초등 글쓰기 능력 향상을 위한 맞춤형 분석 도우미</p>
           </div>
           <div class="input-grid mb-4">
               <input type="text" id="grade" placeholder="학년" class="border p-2 sm:p-3 rounded text-lg w-full">
               <input type="text" id="class" placeholder="반" class="border p-2 sm:p-3 rounded text-lg w-full">
               <input type="text" id="number" placeholder="번호" class="border p-2 sm:p-3 rounded text-lg w-full">
               <input type="text" id="name" placeholder="이름" class="border p-2 sm:p-3 rounded text-lg w-full">
           </div>
           <input type="text" id="title" placeholder="제목" class="border p-2 sm:p-3 rounded w-full mb-4 text-lg">
           <div class="guide-container">
               <div class="writing-guide">
                   <div class="guide-title">
                       <span class="guide-icon">✍️</span>
                       좋은 글쓰기 도움말
                   </div>
                   <ul class="guide-tips">
                       <li>• 한 문단은 3~5개의 문장으로 구성해요</li>
                       <li>• 새로운 내용이 시작되면 문단을 나눠요</li>
                       <li>• 문단의 첫 문장에 중심 내용을 담아요</li>
                   </ul>
               </div>
               <div class="writing-guide">
                   <div class="guide-title">
                       <span class="guide-icon">📝</span>
                       글쓰기 나침반 사용방법
                   </div>
                   <ul class="guide-tips">
                       <li>• 글을 작성한 후 문단 제안하기를 눌러 문단 나누기 도움을 받아요</li>
                       <li>• 도움말을 참고하여 문단을 나눈 뒤 분석하기 버튼을 눌러요</li>
                       <li>• 자세한 분석 결과와 제안을 확인하고 글을 수정해보세요</li>
                   </ul>
               </div>
           </div>
               <!-- 문단 컨트롤 버튼 -->
               <div class="paragraph-controls">
                   <button class="paragraph-button suggestion-button" onclick="getParagraphSuggestions()">
                       <span>문단 제안하기</span>
                       <span class="button-icon">💡</span>
                   </button>
                   <button class="paragraph-button preview-button" onclick="toggleParagraphPreview()">
                       <span>문단 미리보기</span>
                       <span class="button-icon">👁️</span>
                   </button>
               </div>

               <div id="previewContent" class="preview-content hidden"></div>
               <!-- 분석 결과를 표시할 컨테이너 -->
               <div id="analysisResult" class="analysis-container hidden"></div>
               <div class="text-area-wrapper">
                   <textarea 
                       id="content" 
                       placeholder="이곳에 글을 작성하세요. 
           문단을 나누고 싶을 때는 Enter키를 한 번 눌러주세요." 
                       class="border p-2 sm:p-3 rounded w-full h-64 text-lg"
                   ></textarea>
                   <div class="paragraph-suggestions"></div>
               </div>
               <div class="writing-feedback">
                   <div class="char-count">
                       <span>글자수: 0자</span>
                   </div>
                   <div class="paragraph-count">
                       <span>문단수: 0개</span>
                   </div>
                   <div class="paragraph-analysis">
                       <span>문단 분석: 적절한 문단 구분이 필요해요</span>
                   </div>
               </div>
           </div>

           <div class="button-and-credits">
               <button id="submitBtn" class="bg-blue-500 text-white px-4 sm:px-6 py-2 sm:py-3 rounded text-lg font-medium hover:bg-blue-600 w-full sm:w-auto">
                   분석하기
               </button>
               <div class="credits text-gray-500 text-sm flex items-center">
                   Created by B.S.Park. Powered by GPT 4o-mini.
               </div>
           </div>
       </div>

        <div id="result" class="container mx-auto px-4 hidden">
           <!-- 분석 결과 템플릿 -->
           <script type="text/template" id="analysisTemplate">
               <!-- 첫 번째 페이지 시작 -->
               <div class="bg-white rounded-lg shadow-lg p-4 sm:p-8 mb-6 print-page page-1">
                   <div class="result-title-container">
                       <div class="result-title">글쓰기 평가 결과</div>
                       <div class="result-date">${new Date().toLocaleDateString('ko-KR')} 분석</div>
                   </div>

                   <div class="student-info-grid">
                       <div class="student-info-item">학년: ${essayData.grade}</div>
                       <div class="student-info-item">반: ${essayData.class}</div>
                       <div class="student-info-item">번호: ${essayData.number}</div>
                       <div class="student-info-item">이름: ${essayData.name}</div>
                   </div>

                   <div class="flex flex-col gap-8 p-6">
                       <div class="flex items-center gap-6">
                           <div class="flex items-center">
                               <div class="bg-blue-100 rounded-full w-24 h-24 flex items-center justify-center">
                                   <span class="text-blue-600 text-4xl font-bold">${score}점</span>
                               </div>
                           </div>
                           <div class="h-20 w-px bg-gray-200 mx-4"></div>
                           <p class="text-gray-700 text-lg flex-1">${totalEvaluation}</p>
                       </div>

                       <div class="flex gap-12">
                           <div class="w-[400px] flex-shrink-0">
                               ${createRadarChart(Object.entries(scores).map(([name, data]) => ({
                                   name,
                                   grade: data.grade
                               })))}
                           </div>

                           <div class="flex flex-col flex-1 gap-6">
                               <div class="grid grid-cols-2 gap-4">
                                   ${Object.entries(categories).map(([category, description]) => {
                                       const data = scores[category];
                                       return `
                                           <div class="bg-gray-50 p-4 rounded-lg flex items-center justify-between gap-4">
                                               <div>
                                                   <div class="text-lg font-medium text-gray-900">${category}</div>
                                                   <div class="text-sm text-gray-500">${description}</div>
                                               </div>
                                               <div class="grade-badge ${getGradeStyle(data.grade)}">
                                                   ${data.grade}
                                               </div>
                                           </div>
                                       `;
                                   }).join('')}
                               </div>

                               <div class="grid grid-cols-4 gap-3">
                                   <div class="bg-gray-50 p-6 rounded-lg text-center h-28 flex flex-col justify-center">
                                       <div class="text-base text-gray-500">총 글자 수</div>
                                       <div class="text-2xl font-bold text-blue-600">${statistics.charCount}자</div>
                                   </div>
                                   <div class="bg-gray-50 p-6 rounded-lg text-center h-28 flex flex-col justify-center">
                                       <div class="text-base text-gray-500">총 문장 수</div>
                                       <div class="text-2xl font-bold text-blue-600">${statistics.sentenceCount}개</div>
                                   </div>
                                   <div class="bg-gray-50 p-6 rounded-lg text-center h-28 flex flex-col justify-center">
                                       <div class="text-base text-gray-500">총 문단 수</div>
                                       <div class="text-2xl font-bold text-blue-600">${statistics.paragraphCount}개</div>
                                   </div>
                                   <div class="bg-gray-50 p-6 rounded-lg text-center h-28 flex flex-col justify-center">
                                       <div class="text-base text-gray-500">평균 문장 길이</div>
                                       <div class="text-2xl font-bold text-blue-600">${statistics.avgSentenceLength}자</div>
                                   </div>
                               </div>
                           </div>
                       </div>
                   </div>
               </div>
               <!-- 첫 번째 페이지 끝 -->
               <!-- 두 번째 페이지 시작 -->
               <div class="bg-white rounded-lg shadow-lg p-4 sm:p-8 mb-6 print-page page-2">
                   <h2 class="section-title">문단 구성 제안</h2>
                   <div class="structure-content">
                       <div class="structure-box">
                           <div class="structure-box-title">현재 문단 구조</div>
                           ${formatStructureContent(currentStructure, 'current')}
                       </div>
                       <div class="structure-box">
                           <div class="structure-box-title">문단 구성 개선안</div>
                           ${formatStructureContent(improvedStructure, 'improved')}
                       </div>
                       <div class="structure-box">
                           <div class="structure-box-title">구체적 실행 방안</div>
                           ${formatStructureContent(structureSuggestions, 'suggestions')}
                       </div>
                   </div>
               </div>
              <!-- 두 번째 페이지 끝 -->
               <!-- 두 번째 페이지 시작 -->
               <div class="bg-white rounded-lg shadow-lg p-4 sm:p-8 mb-6 print-page page-2">
                   <h2 class="section-title">영역별 분석</h2>
                   <div class="category-grid">
                       ${Object.entries(scores).map(([category, data]) => `
                           <div class="analysis-category-section">
                               <div class="category-header">
                                   <div class="category-title-wrap">
                                       <div class="category-name">${category}</div>
                                       <div class="category-subtitle">${categories[category]}</div>
                                   </div>
                                   <div class="category-grade ${getGradeStyle(data.grade)}">
                                       ${data.grade}
                                   </div>
                               </div>
                               <div class="feedback-grid">
                                   <div class="feedback-box analysis">
                                       <div class="feedback-title analysis">평가</div>
                                       <div class="feedback-content">${data.evaluation}</div>
                                   </div>
                                   <div class="feedback-box good-points">
                                       <div class="feedback-title good-points">잘된 점</div>
                                       <div class="feedback-content">${data.goodPoints}</div>
                                   </div>
                                   <div class="feedback-box improvements">
                                       <div class="feedback-title improvements">개선점</div>
                                       <div class="feedback-content">${data.improvements}</div>
                                   </div>
                               </div>
                           </div>
                       `).join('')}
                   </div>
               </div>
               <!-- 두 번째 페이지 끝 -->

               <!-- 세 번째 페이지 시작 -->
               <div class="bg-white rounded-lg shadow-lg p-4 sm:p-8 mb-6 print-page page-3">
                   <!-- 제목 분석 섹션 -->
                   <div class="analysis-category-section">
                       <div class="category-header">
                           <div class="category-title-wrap">
                               <div class="category-name">제목 분석</div>
                               <div class="category-subtitle">제목의 명확성과 내용 연관성</div>
                           </div>
                           <div class="category-grade ${getGradeStyle(titleData.grade)}">
                               ${titleData.grade}
                           </div>
                       </div>
                       <div class="feedback-grid">
                           <div class="feedback-box analysis">
                               <div class="feedback-title analysis">현재 제목</div>
                               <div class="feedback-content">${titleData.current}</div>
                           </div>
                           <div class="feedback-box good-points">
                               <div class="feedback-title good-points">분석</div>
                               <div class="feedback-content">${titleData.analysis}</div>
                           </div>
                           <div class="feedback-box improvements">
                               <div class="feedback-title improvements">제안</div>
                               <div class="feedback-content">${titleData.suggestions.join('\n')}</div>
                           </div>
                       </div>
                   </div>

                   <!-- 문단별 상세 분석 섹션 -->
                   <h2 class="section-title">문단별 상세 분석</h2>

                   <!-- 문단들을 감싸는 컨테이너 -->
                   <div class="paragraphs-container">
                       ${paragraphs.map(function(paragraph) {
                           return `
                           <div class="paragraph-section">
                               <div class="paragraph-header">
                                   <h4 class="paragraph-title">${paragraph.index}번째 문단</h4>
                               </div>
                               <div class="original-text">${paragraph.content}</div>
                               <div class="paragraph-analysis">
                                   <div class="analysis-type analysis">
                                       <div class="analysis-type-header">분석</div>
                                       <div class="analysis-content">${paragraph.analysis}</div>
                                   </div>
                                   <div class="analysis-type good-points">
                                       <div class="analysis-type-header">잘된 점</div>
                                       <div class="analysis-content">${paragraph.goodPoints}</div>
                                   </div>
                                   <div class="analysis-type improvements">
                                       <div class="analysis-type-header">개선점</div>
                                       <div class="analysis-content">${paragraph.improvements}</div>
                                   </div>
                               </div>
                               ${paragraph.suggestions.length > 0 ? `
                                   <div class="suggestion-box">
                                       <div class="suggestion-title">표현 개선 제안</div>
                                       <ul class="suggestion-list">
                                           ${paragraph.suggestions.map(function(suggestion) {
                                               return `<li class="suggestion-item">${suggestion}</li>`;
                                           }).join('')}
                                       </ul>
                                   </div>
                               ` : ''}
                           </div>
                           `;
                       }).join('')}
                   </div>
                   <!-- 문단별 상세 분석 섹션 끝 -->

                   <!-- 문단 구성 제안 섹션 -->
                   <h2 class="section-title">문단 구성 제안</h2>
                   <div class="structure-content">
                       <div class="structure-box">
                           <div class="structure-box-title">현재 문단 구조</div>
                           <div class="structure-list">
                               ${formatStructureContent(currentStructure)}
                           </div>
                       </div>
                       <div class="structure-box">
                           <div class="structure-box-title">문단 구성 개선안</div>
                           <div class="structure-list">
                               ${formatStructureContent(improvedStructure, 'improved')}
                           </div>
                       </div>
                       <div class="structure-box">
                           <div class="structure-box-title">구체적 실행 방안</div>
                           <div class="structure-list">
                               ${formatStructureContent(structureSuggestions)}
                           </div>
                       </div>
                   </div>
               </div>
               <!-- 세 번째 페이지 끝 -->

               <div class="print-button-container no-print">
                   <button onclick="window.print()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                       프린트하기
                   </button>
               </div>
           </script>
       </div>


     <script>
        function countCharacters(text) {
            if (!text) return 0;
            // 줄바꿈만 제외하고 나머지 공백은 포함
            return text.replace(/\n/g, '').length;
        }

         function calculateTotalScore(scores, titleData) {
             console.log('calculateTotalScore 호출됨');
             console.log('전달받은 titleData:', titleData);

             const gradePoints = {
                 'A+': 100,
                 'A': 90,
                 'B+': 80,
                 'B': 70,
                 'C+': 60,
                 'C': 50,
                 'D+': 40,
                 'D': 35,
                 'F': 30
             };

             const weights = {
                 '논리성': 0.30,
                 '구조성': 0.25,
                 '표현성': 0.20,
                 '완성도': 0.15,
                 '제목': 0.10
             };

             let totalScore = 0;

             // 기존 점수 계산
             Object.entries(scores).forEach(([category, data]) => {
                 const gradePoint = gradePoints[data.grade] || 50;
                 const weightedScore = gradePoint * weights[category];
                 console.log(`${category}: ${data.grade} (${gradePoint}) × ${weights[category]} = ${weightedScore}`);
                 totalScore += weightedScore;
             });

             // 제목 점수 계산
             if (titleData && titleData.grade) {
                 const titleGradePoint = gradePoints[titleData.grade] || 50;
                 const titleWeightedScore = titleGradePoint * weights['제목'];
                 console.log(`제목: ${titleData.grade} (${titleGradePoint}) × ${weights['제목']} = ${titleWeightedScore}`);
                 totalScore += titleWeightedScore;
             }

             return Math.ceil(totalScore);
         }

        function extractScore(analysis, category) {
            try {
                const sectionRegex = new RegExp(`\\[${category}\\][^]*?(?=\\[|#|$)`);
                const section = analysis.match(sectionRegex)?.[0] || '';
                const gradeMatch = section.match(/등급:\s*([A-F][+]?)/);
                return {
                    grade: gradeMatch ? gradeMatch[1] : 'F'
                };
            } catch (error) {
                console.error(`Error extracting score for ${category}:`, error);
                return { grade: 'F' };
            }
        }

         // 점수 검증 함수 추가
         function validateScores(scores, paragraphCount) {
             if (paragraphCount <= 1) {
                 // 한 문단일 경우 점수를 강제로 조정
                 console.log('한 문단 검출: 점수 강제 조정');

                 // 구조성 점수는 D+ 이하로 강제
                 if (['A+', 'A', 'B+', 'B', 'C+', 'C', 'D+'].includes(scores['구조성'].grade)) {
                     scores['구조성'].grade = 'D';
                 }

                 // 완성도 점수는 C+ 이하로 강제
                 if (['A+', 'A', 'B+', 'B'].includes(scores['완성도'].grade)) {
                     scores['완성도'].grade = 'C';
                 }

                 console.log('조정된 점수:', {
                     '구조성': scores['구조성'].grade,
                     '완성도': scores['완성도'].grade
                 });
             }
             return scores;
         }

        function createRadarChart(categories) {
            const size = 550;
            const center = size / 2;
            const radius = size * 0.35;
            const pointCount = categories.length;
            const angleStep = (Math.PI * 2) / pointCount;

            let points = categories.map((cat, i) => {
                const angle = i * angleStep - Math.PI / 2;
                const value = convertGradeToValue(cat.grade);
                const x = center + radius * value * Math.cos(angle);
                const y = center + radius * value * Math.sin(angle);
                return { x, y };
            });

            let pathData = points.map((p, i) => 
                (i === 0 ? 'M' : 'L') + `${p.x},${p.y}`
            ).join(' ') + 'Z';

            return `
                <svg viewBox="0 0 ${size} ${size}" class="radar-chart" style="overflow: visible;">
                    ${[0.2, 0.4, 0.6, 0.8, 1].map(r => `
                        <circle 
                            cx="${center}" 
                            cy="${center}" 
                            r="${radius * r}" 
                            fill="none" 
                            stroke="#e5e7eb" 
                            stroke-width="2"
                        />
                    `).join('')}

                    ${categories.map((_, i) => {
                        const angle = i * angleStep - Math.PI / 2;
                        return `
                            <line 
                                x1="${center}" 
                                y1="${center}" 
                                x2="${center + radius * Math.cos(angle)}" 
                                y2="${center + radius * Math.sin(angle)}" 
                                stroke="#e5e7eb" 
                                stroke-width="2"
                            />
                        `;
                    }).join('')}

                    <path 
                        d="${pathData}" 
                        fill="rgba(147, 197, 253, 0.3)" 
                        stroke="#3b82f6" 
                        stroke-width="3"
                    />

                    ${categories.map((cat, i) => {
                                       const angle = i * angleStep - Math.PI / 2;
                                       const x = center + (radius + 50) * Math.cos(angle);  // 40에서 50으로 증가
                                       const y = center + (radius + 50) * Math.sin(angle);
                                       return `
                                           <text 
                                               x="${x}" 
                                               y="${y}" 
                                               text-anchor="middle" 
                                               dominant-baseline="middle"
                                               class="text-lg font-medium"
                                               style="font-size: 22px; font-weight: 600;"  // 글자 크기와 두께 직접 지정
                                           >${cat.name}</text>
                                       `;
                                   }).join('')}
                               </svg>
                           `;
                       }

        function convertGradeToValue(grade) {
            const gradeValues = {
                'A+': 1.0, 'A': 0.9,
                'B+': 0.8, 'B': 0.7,
                'C+': 0.6, 'C': 0.5,
                'D+': 0.4, 'D': 0.3,
                'F': 0.2
            };
            return gradeValues[grade] || 0.2;
        }
        // getParagraphSuggestions 함수 추가
             async function getParagraphSuggestions() {
                 const content = document.getElementById('content').value.trim();
                 if (!content) {
                     alert('글을 작성한 후에 문단 제안을 받아보세요.');
                     return;
                 }

                 const suggestionButton = document.querySelector('.suggestion-button');
                 suggestionButton.disabled = true;
                 suggestionButton.innerHTML = '<span>제안받는 중...</span>';

                 try {
                     const response = await fetch('/.netlify/functions/paragraphSuggestions', {
                         method: 'POST',
                         headers: {
                             'Content-Type': 'application/json',
                         },
                         body: JSON.stringify({ content })
                     });

                     if (!response.ok) {
                         throw new Error('API 요청 실패');
                     }

                     const data = await response.json();
                     displayParagraphSplits(data.paragraphs);
                 } catch (error) {
                     console.error('문단 제안 오류:', error);
                     alert('문단 제안 중 오류가 발생했습니다. 다시 시도해주세요.');
                 } finally {
                     suggestionButton.disabled = false;
                     suggestionButton.innerHTML = '<span>문단 제안하기</span><span class="button-icon">💡</span>';
                 }
             }


        // 문단 분할 표시 함수
       function displayParagraphSplits(paragraphs) {
           const previewContent = document.getElementById('previewContent');
           const previewButton = document.querySelector('.preview-button');
           previewContent.innerHTML = '';

           paragraphs.forEach((para, index) => {
               const paraElement = document.createElement('div');
               paraElement.classList.add('paragraph-split');
               paraElement.innerHTML = `
                   <div class="paragraph-text"><strong>${index + 1}문단:</strong> ${para.text}</div>
                   <div class="paragraph-reason"><em>이렇게 나눈 이유:</em> ${para.reason}</div>
               `;
               previewContent.appendChild(paraElement);
           });

           previewContent.classList.remove('hidden');
           previewButton.innerHTML = '<span>문단 미리보기 닫기</span><span class="button-icon">👁️</span>';
       }

       // 문단 미리보기 토글 함수
       function toggleParagraphPreview() {
           const previewContent = document.getElementById('previewContent');
           const previewButton = document.querySelector('.preview-button');
           if (previewContent.classList.contains('hidden')) {
               previewContent.classList.remove('hidden');
               previewButton.innerHTML = '<span>문단 미리보기 닫기</span><span class="button-icon">👁️</span>';
           } else {
               previewContent.classList.add('hidden');
               previewButton.innerHTML = '<span>문단 미리보기</span><span class="button-icon">👁️</span>';
           }
       }


            function displayParagraphSuggestions(suggestions) {
                // 불필요한 기호 제거
                let cleanedSuggestions = suggestions.replace(/[#!*>_~`-]/g, '').trim();

                // 번호 패턴을 기준으로 응답 분할 (예: 1) 내용)
                const suggestionItems = cleanedSuggestions.split(/\d+\)\s/).filter(item => item.trim() !== '');

                // 제안 내용이 없는 경우 처리
                if (suggestionItems.length === 0) {
                    suggestionItems.push('제안된 문단 구성이 없습니다.');
                }

                // 제안 내용을 표시할 컨테이너를 찾거나 생성
                let suggestionContainer = document.getElementById('paragraphSuggestionContainer');
                if (!suggestionContainer) {
                    suggestionContainer = document.createElement('div');
                    suggestionContainer.id = 'paragraphSuggestionContainer';
                    suggestionContainer.className = 'paragraph-suggestions-container';
                    // 적절한 위치에 컨테이너 추가
                    const textareaContainer = document.querySelector('.textarea-container');
                    textareaContainer.parentNode.insertBefore(suggestionContainer, textareaContainer.nextSibling);
                }

                // 제안 내용을 컨테이너에 삽입
                suggestionContainer.innerHTML = `
                    <h3 class="suggestion-title">문단 구성 제안</h3>
                    <div class="suggestion-cards">
                        ${suggestionItems.map((item, index) => `
                            <div class="suggestion-card">
                                <div class="suggestion-number">${index + 1}번째 문단</div>
                                <div class="suggestion-text">${item.trim()}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

        function displayParagraphDescriptions(descriptions) {
            // 제안 내용을 표시할 컨테이너를 찾거나 생성
            let suggestionContainer = document.getElementById('paragraphSuggestionContainer');
            if (!suggestionContainer) {
                suggestionContainer = document.createElement('div');
                suggestionContainer.id = 'paragraphSuggestionContainer';
                suggestionContainer.className = 'paragraph-suggestions-container';
                // 적절한 위치에 컨테이너 추가
                const contentContainer = document.getElementById('contentWithBreaks');
                contentContainer.parentNode.insertBefore(suggestionContainer, contentContainer.nextSibling);
            }

            // 제안 내용을 컨테이너에 삽입
            suggestionContainer.innerHTML = `
                <h3 class="suggestion-title">문단 구성 제안</h3>
                <div class="suggestion-cards">
                    ${descriptions.map((item, index) => `
                        <div class="suggestion-card">
                            <div class="suggestion-number">${index + 1}번째 문단</div>
                            <div class="suggestion-text">${item.trim()}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }


        function displayParagraphBreaks(breakPositions, content) {
            // 글자 인덱스를 기준으로 글을 분할하고, 문단 분할 위치에 표시 추가
            let highlightedContent = '';
            let lastIndex = 0;

            for (let i = 0; i <= breakPositions.length; i++) {
                let endIndex = breakPositions[i] || content.length;
                let paragraphText = content.substring(lastIndex, endIndex);

                // 문단 분할 표시 추가 (예: 문단 끝에 선 추가)
                highlightedContent += `<div class="paragraph-suggestion">${paragraphText}</div>`;

                lastIndex = endIndex;
            }

            // 결과를 표시할 컨테이너에 삽입
            let contentContainer = document.getElementById('contentWithBreaks');
            if (!contentContainer) {
                contentContainer = document.createElement('div');
                contentContainer.id = 'contentWithBreaks';
                contentContainer.className = 'content-with-breaks';
                // 적절한 위치에 컨테이너 추가
                const textareaContainer = document.querySelector('.textarea-container');
                textareaContainer.parentNode.insertBefore(contentContainer, textareaContainer.nextSibling);
            }

            contentContainer.innerHTML = `
                <h3 class="suggestion-title">문단 분할 제안</h3>
                ${highlightedContent}
            `;
        }



        // 모달 제어 함수
        function showTipModal() {
            const modal = document.getElementById('tipModal');
            const overlay = document.getElementById('modalOverlay');
            if (modal && overlay) {
                modal.classList.add('active');
                overlay.classList.add('active');
            }
        }

        function closeTipModal() {
            const modal = document.getElementById('tipModal');
            const overlay = document.getElementById('modalOverlay');
            if (modal && overlay) {
                modal.classList.remove('active');
                overlay.classList.remove('active');
            }
        }

         function displayAnalysis(analysis, essayData) {
         const result = document.getElementById('result');

         // 제목 분석 데이터 먼저 추출
         const titleSection = analysis.match(/# 제목 분석\n([\s\S]+?)(?=\n#|$)/)?.[1] || '';
         const titleData = {
             current: essayData.title || '',
             grade: titleSection.match(/등급:\s*([A-F][+]?)/)?.[1] || 'C',
             analysis: titleSection.match(/분석:([\s\S]*?)(?=\n제안:|$)/)?.[1]?.trim() || '',
             suggestions: titleSection.match(/제안:([\s\S]*?)$/)?.[1]?.split(/\d+\.\s*/)
                 .filter(s => s.trim())
                 .map(s => s.trim()) || []
         };

         // 평가 항목 데이터 추출
         const categories = {
             '논리성': '주장과 근거의 타당성, 논리적 흐름',
             '구조성': '글의 구조와 문단 간 연결성',
             '표현성': '어휘와 문장의 표현, 맞춤법',
             '완성도': '전체적인 글의 완성도와 통일성'
         };

         // scores 객체 생성
        const scores = {};
        Object.keys(categories).forEach(category => {
            scores[category] = extractCategoryData(analysis, category);
        });

         // 디버깅을 위한 로그 추가
         console.log('제목 데이터:', titleData);
         console.log('점수 데이터:', scores);

         // 원문 텍스트 가져오기
         const originalText = essayData.content;
         const hasVisibleBreaks = originalText.includes('\n');

         // 문단 분석 데이터 추출
         const extractedParagraphs = extractParagraphs(analysis);
         const paragraphCount = hasVisibleBreaks ? extractedParagraphs.length : 1;

         // 점수 검증 추가
         const validatedScores = validateScores(scores, paragraphCount);

         // 총점 계산 시 titleData 전달
         const score = calculateTotalScore(validatedScores, titleData);
         const totalEvaluation = analysis.match(/총평:\s*([^\n]+)/)?.[1] || '';

         // 문단 구분 알림창 표시 여부
         const showParagraphAlert = !hasVisibleBreaks && originalText.length > 200;

         // 문단 구성 제안 데이터 추출
         const structureSection = analysis.match(/# 문단 구성 제안\n([\s\S]+?)(?=\n#|$)/)?.[1] || '';

         const currentStructure = structureSection.match(/현재 문단 구조:([\s\S]+?)(?=문단 구성 개선안:|$)/i)?.[1]?.trim() || '';
         const improvedStructure = structureSection.match(/문단 구성 개선안:([\s\S]+?)(?=구체적 실행 방안:|$)/i)?.[1]?.trim() || '';
         const structureSuggestions = structureSection.match(/구체적 실행 방안:([\s\S]*?)$/i)?.[1]?.trim() || '';

         const hasCurrent = Boolean(currentStructure);
         const hasImproved = Boolean(improvedStructure);
         const hasSuggestions = Boolean(structureSuggestions);

         // 통계 데이터 추출
         const actualSentenceCount = countSentences(essayData.content);
         const actualCharCount = countCharacters(essayData.content);

         // 통계 객체 생성
         const statistics = {
             charCount: actualCharCount,
             sentenceCount: actualSentenceCount,
             paragraphCount: paragraphCount,
             avgSentenceLength: Math.round(actualCharCount / actualSentenceCount) || 0
         };

            // 결과 HTML 생성
            let resultHTML = `
                <!-- 결과 전체를 감싸는 큰 사각 박스 시작 -->
                <div class="bg-white rounded-lg shadow-lg p-4 sm:p-8 mb-6 print-section">
                    ${showParagraphAlert ? `
                        <div class="paragraph-alert mb-6">
                            <div class="alert-title">
                                <span class="alert-icon">💡</span>
                                문단 나누기가 필요해요!
                            </div>
                            <div class="alert-content">
                                <p style="text-indent: 1.5em;">긴 글을 한 번에 쭉 쓰면 읽기가 어려워요. 다음과 같이 문단을 나누면 더 좋은 글이 될 거예요:</p>
                                <ul class="mt-2">
                                    <li>✍️ 비슷한 내용끼리 모아서 한 문단으로 만들기</li>
                                    <li>✍️ 한 문단은 3~5개의 문장으로 구성하기</li>
                                    <li>✍️ 새로운 내용이 시작되면 한 줄 띄우기</li>
                                </ul>
                            </div>
                        </div>
                    ` : ''}

                    <!-- 제목 부분 -->
                    <div class="result-title-container">
                        <div class="result-title">글쓰기 평가 결과</div>
                        <div class="result-date">${new Date().toLocaleDateString('ko-KR')} 분석</div>
                    </div>

                    <!-- 학생 정보 -->
                    <div class="student-info-card bg-gray-50 p-4 rounded-lg mb-6 flex items-center gap-4">
                        <div class="student-info-item flex items-center">
                            <span class="student-info-icon text-2xl mr-2">🎓</span>
                            <span class="student-info-label font-semibold text-gray-700 mr-1">학년:</span>
                            <span class="student-info-value font-medium text-gray-800">${essayData.grade}</span>
                        </div>
                        <div class="student-info-item flex items-center">
                            <span class="student-info-icon text-2xl mr-2">🏫</span>
                            <span class="student-info-label font-semibold text-gray-700 mr-1">반:</span>
                            <span class="student-info-value font-medium text-gray-800">${essayData.class}</span>
                        </div>
                        <div class="student-info-item flex items-center">
                            <span class="student-info-icon text-2xl mr-2">🔢</span>
                            <span class="student-info-label font-semibold text-gray-700 mr-1">번호:</span>
                            <span class="student-info-value font-medium text-gray-800">${essayData.number}</span>
                        </div>
                        <div class="student-info-item flex items-center">
                            <span class="student-info-icon text-2xl mr-2">📝</span>
                            <span class="student-info-label font-semibold text-gray-700 mr-1">이름:</span>
                            <span class="student-info-value font-medium text-gray-800">${essayData.name}</span>
                        </div>
                    </div>


                    <!-- 평가 개요 섹션 -->
                    <div class="flex flex-col gap-8 p-6">
                        <!-- 점수와 총평 섹션 -->
                        <div class="flex items-center gap-6">
                            <div class="flex items-center">
                                <div class="bg-blue-100 rounded-full w-24 h-24 flex items-center justify-center">
                                    <span class="text-blue-600 text-4xl font-bold">${score}점</span>
                                </div>
                            </div>
                            <div class="h-20 w-px bg-gray-200 mx-4"></div>
                            <p class="text-gray-700 text-lg flex-1">${totalEvaluation}</p>
                        </div>

                        <!-- 레이더 차트와 오른쪽 컨텐츠 -->
                        <div class="flex gap-12">
                            <!-- 레이더 차트 -->
                            <div class="w-[400px] flex-shrink-0">
                                ${createRadarChart(Object.entries(scores).map(([name, data]) => ({
                                    name,
                                    grade: data.grade
                                })))}
                            </div>

                            <!-- 오른쪽 컨텐츠 컨테이너 -->
                            <div class="flex flex-col flex-1 gap-6">
                                <!-- 평가 항목 그리드 -->
                                <div class="grid grid-cols-2 gap-4">
                                    ${Object.entries(categories).map(([category, description]) => {
                                        const data = scores[category];
                                        return `
                                            <div class="bg-gray-50 p-4 rounded-lg flex items-center justify-between gap-4">
                                                <div>
                                                    <div class="text-lg font-medium text-gray-900">${category}</div>
                                                    <div class="text-sm text-gray-500">${description}</div>
                                                </div>
                                                <div class="grade-badge ${getGradeStyle(data.grade)}">
                                                    ${data.grade}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>

                                <!-- 통계 정보 -->
                                <div class="grid grid-cols-4 gap-3">
                                    <div class="bg-gray-50 p-6 rounded-lg text-center h-28 flex flex-col justify-center">
                                        <div class="text-base text-gray-500">총 글자 수</div>
                                        <div class="text-2xl font-bold text-blue-600">${statistics.charCount}자</div>
                                    </div>
                                    <div class="bg-gray-50 p-6 rounded-lg text-center h-28 flex flex-col justify-center">
                                        <div class="text-base text-gray-500">총 문장 수</div>
                                        <div class="text-2xl font-bold text-blue-600">${statistics.sentenceCount}개</div>
                                    </div>
                                    <div class="bg-gray-50 p-6 rounded-lg text-center h-28 flex flex-col justify-center">
                                        <div class="text-base text-gray-500">총 문단 수</div>
                                        <div class="text-2xl font-bold text-blue-600">${statistics.paragraphCount}개</div>
                                    </div>
                                    <div class="bg-gray-50 p-6 rounded-lg text-center h-28 flex flex-col justify-center">
                                        <div class="text-base text-gray-500">평균 문장 길이</div>
                                        <div class="text-2xl font-bold text-blue-600">${statistics.avgSentenceLength}자</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 영역별 분석 -->
                    <h2 class="section-title">영역별 분석</h2>
                    <div class="category-grid">
                        ${Object.entries(scores).map(([category, data]) => `
                            <div class="analysis-category-section">
                                <div class="category-header">
                                    <div class="category-title-wrap">
                                        <div class="category-name">${category}</div>
                                        <div class="category-subtitle">${categories[category]}</div>
                                    </div>
                                    <div class="category-grade ${getGradeStyle(data.grade)}">
                                        ${data.grade}
                                    </div>
                                </div>
                                <div class="feedback-grid">
                                    <div class="feedback-box analysis">
                                        <div class="feedback-title analysis">평가</div>
                                        <div class="feedback-content">${data.evaluation}</div>
                                    </div>
                                    <div class="feedback-box good-points">
                                        <div class="feedback-title good-points">잘된 점</div>
                                        <div class="feedback-content">${data.goodPoints}</div>
                                    </div>
                                    <div class="feedback-box improvements">
                                        <div class="feedback-title improvements">개선점</div>
                                        <div class="feedback-content">${data.improvements}</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- 제목 분석 섹션 -->
                    <div class="title-analysis">
                        <div class="section-header flex justify-between items-center">
                            <div style="display: flex; align-items: center; gap: 2rem;">
                                <h2 class="section-title">제목 분석</h2>
                                <div class="category-grade ${getGradeStyle(titleData?.grade || 'C')}">
                                    ${titleData?.grade || 'C'}
                                </div>
                            </div>
                        </div>
                        <div class="title-analysis-content">
                            <div class="title-analysis-item">
                                <div class="title-analysis-label">현재 제목</div>
                                <div class="text-gray-700">${titleData.current}</div>
                            </div>
                            <div class="title-analysis-item">
                                <div class="title-analysis-label">분석</div>
                                <div class="text-gray-700 whitespace-pre-line">${titleData.analysis}</div>
                            </div>
                            <div class="title-analysis-item">
                                <div class="title-analysis-label">제안</div>
                                <div class="text-gray-700">${titleData.suggestions.join('\n')}</div>
                            </div>
                        </div>
                    </div>

                    <!-- 문단별 상세 분석 -->
                    <h2 class="section-title">문단별 상세 분석</h2>
                    <div class="paragraphs-container">
                        ${extractedParagraphs.map(paragraph => `
                        <div class="paragraph-section mt-8">
                                <div class="paragraph-header">
                                    <h4 class="paragraph-title">${paragraph.index}번째 문단</h4>
                                    <button class="tip-button" type="button" onclick="showTipModal()">문단 구분 팁</button>
                                </div>
                                <div class="original-text">${paragraph.content}</div>
                                <div class="paragraph-analysis-section">
                                    <div class="analysis-box analysis">
                                        <div class="analysis-box-header">분석</div>
                                        <div class="analysis-box-content">${paragraph.analysis}</div>
                                    </div>
                                    <div class="analysis-box good-points">
                                        <div class="analysis-box-header">잘된 점</div>
                                        <div class="analysis-box-content">${paragraph.goodPoints}</div>
                                    </div>
                                    <div class="analysis-box improvements">
                                        <div class="analysis-box-header">개선점</div>
                                        <div class="analysis-box-content">${paragraph.improvements}</div>
                                    </div>
                                </div>
                                ${paragraph.suggestions.length > 0 ? `
                                   <div class="suggestion-box">
                                       <div class="suggestion-title">표현 개선 제안</div>
                                       <ul class="suggestion-list">
                                           ${paragraph.suggestions.map(function(suggestion) {
                                               return `<li class="suggestion-item">${suggestion}</li>`;
                                           }).join('')}
                                       </ul>
                                   </div>
                                   <div class="suggestion-box spelling">
                                       <div class="suggestion-title">맞춤법 교정</div>
                                       <ul class="suggestion-list">
                                           ${paragraph.spellingCorrections?.map(function(correction) {
                                               return `<li class="suggestion-item">
                                                   <span class="correction-original">${correction.original}</span> →
                                                   <span class="correction-fixed">${correction.fixed}</span>
                                                   <div class="correction-reason">${correction.reason}</div>
                                               </li>`;
                                           }).join('') || '맞춤법 교정이 필요하지 않습니다.'}
                                       </ul>
                                   </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>

                    <!-- 모달 창 추가 -->
                    <div class="tip-modal hidden" id="tipModal">
                        <h3 class="text-xl font-bold mb-4">문단 나누기 Tips!</h3>
                        <ul class="space-y-2">
                            <li>✍️ 하나의 문단에는 하나의 중심 생각만 담아요.</li>
                            <li>✍️ 새로운 내용이 시작되면 새로운 문단으로 나눠요.</li>
                            <li>✍️ 문단의 첫 문장에 중심 내용을 담아요.</li>
                            <li>✍️ 보통 3~5문장이 한 문단이 되어요.</li>
                            <li>✍️ 들여쓰기로 문단의 시작을 표시해요.</li>
                        </ul>
                        <button class="mt-4 bg-blue-500 text-white px-4 py-2 rounded" onclick="closeTipModal()">
                            알겠어요!
                        </button>
                    </div>
                    <div class="modal-overlay hidden" id="modalOverlay" onclick="closeTipModal()"></div>

                    <!-- 문단 구성 제안 -->
                    <h2 class="section-title">문단 구성 제안</h2>
                    <div class="structure-container">
                        <div class="structure-section">
                            <h3 class="structure-section-title">현재 문단 구조</h3>
                            ${formatStructureContent(currentStructure, 'current')}
                        </div>
                        <div class="structure-section">
                            <h3 class="structure-section-title">문단 구성 개선안</h3>
                            ${formatStructureContent(improvedStructure, 'improved')}
                        </div>
                        <div class="structure-section">
                            <h3 class="structure-section-title">구체적 실행 방안</h3>
                            ${formatStructureContent(structureSuggestions, 'suggestions')}
                        </div>
                    </div>
                <!-- 결과 전체를 감싸는 큰 사각 박스 끝 -->

                <!-- 프린트 버튼 -->
                <div class="print-button-container no-print">
                    <button onclick="window.print()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        프린트하기
                    </button>
                </div>
            `;

             // 결과 표시
                 result.innerHTML = resultHTML;
                 result.classList.remove('hidden');
             }


        // 도움 함수들
        function getCategoryDescription(category) {
            const descriptions = {
                '논리성': '주장과 근거의 타당성, 논리적 흐름',
                '구조성': '글의 구조와 문단 간 연결성',
                '표현성': '어휘와 문장의 표현, 맞춤법',
                '완성도': '전체적인 글의 완성도와 통일성'
            };
            return descriptions[category] || '';
        }

        function getGradeStyle(grade) {
            const styles = {
                'A+': 'bg-blue-100 text-blue-800 border-2 border-blue-300',
                'A': 'bg-blue-100 text-blue-800 border-2 border-blue-300',
                'B+': 'bg-green-100 text-green-800 border-2 border-green-300',
                'B': 'bg-green-100 text-green-800 border-2 border-green-300',
                'C+': 'bg-yellow-100 text-yellow-800 border-2 border-yellow-300',
                'C': 'bg-yellow-100 text-yellow-800 border-2 border-yellow-300',
                'D+': 'bg-orange-100 text-orange-800 border-2 border-orange-300',
                'D': 'bg-orange-100 text-orange-800 border-2 border-orange-300',
                'F': 'bg-red-100 text-red-800 border-2 border-red-300'
            };
            return styles[grade] || 'bg-gray-100 text-gray-800 border-2 border-gray-300';
        }

        // 문단 분석 보조 함수
         function extractParagraphs(analysis) {
             const paragraphs = [];
             const paragraphRegex = /\[(\d+)문단\]([\s\S]+?)(?=\[\d+문단\]|#|$)/g;
             const matches = Array.from(analysis.matchAll(paragraphRegex));

             for (const match of matches) {
                 try {
                     const paragraphNum = match[1];
                     const content = match[2];

                     // 각 섹션 추출
                     const originalMatch = content.match(/원문:\s*([\s\S]*?)(?=\s*분석:)/);
                     const analysisMatch = content.match(/분석:\s*([\s\S]*?)(?=\s*잘된 점:)/);
                     const goodPointsMatch = content.match(/잘된 점:\s*([\s\S]*?)(?=\s*개선점:)/);
                     const improvementsMatch = content.match(/개선점:\s*([\s\S]*?)(?=\s*표현 개선 제안:|맞춤법 교정:|$)/);
                     const suggestionsMatch = content.match(/표현 개선 제안:\s*([\s\S]*?)(?=맞춤법 교정:|$)/);
                     const spellingMatch = content.match(/맞춤법 교정:\s*([\s\S]*?)$/);

                     // 원문 처리
                     let originalContent = '';
                     if (originalMatch) {
                         originalContent = originalMatch[1]
                             .replace(/^[\s"]+|[\s"]+$/g, '')
                             .split('\n')
                             .map(line => line.trim())
                             .filter(Boolean)
                             .join('\n');
                     }

                     // 표현 개선 제안 처리
                     const suggestions = suggestionsMatch
                         ? suggestionsMatch[1]
                             .split(/\n/)
                             .map(line => line.trim())
                             .filter(line => line.length > 0 && !line.match(/^[\s*•-]*$/))
                             .map(line => line.replace(/^[*•-]\s*/, ''))
                         : [];

                     // 맞춤법 교정 처리
                     const spellingCorrections = spellingMatch
                         ? spellingMatch[1]
                             .split(/\n/)
                             .map(line => line.trim())
                             .filter(line => line.length > 0)
                             .map(line => {
                                 const [original, fixed, ...rest] = line.split(/\s*->\s*|\s*,\s*/);
                                 return {
                                     original: original?.replace(/^["']|["']$/g, ''),
                                     fixed: fixed?.replace(/^["']|["']$/g, ''),
                                     reason: rest.join(', ').trim()
                                 };
                             })
                             .filter(correction => correction.original && correction.fixed)
                         : [];

                     paragraphs.push({
                         index: paragraphNum,
                         content: originalContent,
                         analysis: analysisMatch?.[1]?.trim() || '',
                         goodPoints: goodPointsMatch?.[1]?.trim() || '',
                         improvements: improvementsMatch?.[1]?.trim() || '',
                         suggestions: suggestions,
                         spellingCorrections: spellingCorrections
                     });
                 } catch (error) {
                     console.error(`문단 ${match[1]} 처리 중 오류:`, error);
                 }
             }

             return paragraphs.sort((a, b) => parseInt(a.index) - parseInt(b.index));
         }

        // 정확한 문장 수 세기 함수
        function countSentences(text) {
            if (!text) return 0;

            // 1. 줄바꿈을 공백으로 변경
            let normalized = text.replace(/\n/g, ' ');

            // 2. 마침표나 느낌표, 물음표 뒤에 공백이나 따옴표가 오는 경우를 문장의 끝으로 간주
            // 또한 줄임표(...)는 문장의 끝으로 간주하지 않음
            const matches = normalized.match(/[^.!?]+[.!?](?:[\s"']|$)/g) || [];

            // 3. 빈 문장이나 공백만 있는 문장 제외
            const validSentences = matches.filter(sentence => 
                sentence.trim().replace(/[.!?]/g, '').trim().length > 0
            );

            // 디버깅을 위한 로그
            console.log("Found sentences:", validSentences);

            return validSentences.length;
        }

        function renderSuggestion(container, suggestion) {
            const suggestionDiv = document.createElement('div');
            suggestionDiv.className = 'suggestion-item bg-white p-4 border-l-4 border-blue-500 my-2';

            suggestionDiv.innerHTML = `
                <p class="text-gray-900 font-medium">${suggestion.breakPoint}</p>
                <p class="text-blue-600 mt-2">💭 ${suggestion.reason}</p>
                <p class="text-green-600 mt-2">✍️ ${suggestion.tip}</p>
                <div class="mt-3">
                    <button onclick="applyParagraphBreak(this)" 
                            class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">
                        이 부분에서 나누기
                    </button>
                </div>
            `;

            container.appendChild(suggestionDiv);
        }

        function applyParagraphBreak(position) {
            const textarea = document.getElementById('content');
            const text = textarea.value;
            position = parseInt(position); // 문자열로 전달된 position을 숫자로 변환

            try {
                // 현재 커서 위치 저장
                const scrollPos = textarea.scrollTop;

                // 문단 나누기 적용
                const newContent = 
                    text.substring(0, position) + 
                    '\n\n' + 
                    text.substring(position);

                // 텍스트 업데이트
                textarea.value = newContent;

                // 스크롤 위치 복원
                textarea.scrollTop = scrollPos;

                // 문단 수 업데이트
                updateParagraphCount();

                // 성공 피드백 표시
                showFeedback();

                // 문단 분석 다시 실행
                analyzeParagraphs();

            } catch (error) {
                console.error('문단 나누기 적용 중 오류:', error);
                alert('문단 나누기를 적용하는 중에 문제가 발생했습니다.');
            }
        }

        // 피드백 메시지 표시 함수
        function showFeedback() {
            const container = document.querySelector('.paragraph-suggestions-container');
            if (!container) return;

            const feedback = document.createElement('div');
            feedback.className = 'feedback-message fixed bottom-4 right-4 bg-green-100 text-green-800 p-4 rounded-lg shadow-lg';
            feedback.innerHTML = `
                <div class="flex items-center gap-2">
                    <span>✨ 문단을 나누었어요!</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-green-600 hover:text-green-800">✕</button>
                </div>
                <p class="text-sm mt-1">더 나은 글이 되어가고 있어요.</p>
            `;

            document.body.appendChild(feedback);

            // 3초 후 자동으로 제거
            setTimeout(() => {
                if (feedback.parentElement) {
                    feedback.remove();
                }
            }, 3000);
        }

        // 문단 수 업데이트 함수
        function updateParagraphCount() {
            const content = document.getElementById('content').value;
            const paragraphCount = document.querySelector('.paragraph-count');
            const count = content.split('\n').filter(p => p.trim().length > 0).length;
            paragraphCount.textContent = `문단수: ${count}개`;
        }
        // 모달 닫기 함수
        function closeModal() {
            const modal = document.querySelector('.tip-modal');
            const overlay = document.querySelector('.modal-overlay');
            if (modal) modal.remove();
            if (overlay) overlay.remove();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const content = document.getElementById('content');
            const charCount = document.querySelector('.char-count');
            const paragraphCount = document.querySelector('.paragraph-count');
            const paragraphAnalysis = document.querySelector('.paragraph-analysis');

            if (!content) return; // content 요소가 없으면 실행하지 않음

            // 텍스트 입력 이벤트 리스너
            content.addEventListener('input', function() {
                // 글자 수 업데이트
                const totalCount = countCharacters(this.value);
                charCount.textContent = `글자수: ${totalCount}자`;

                // 문단 수 업데이트
                const paragraphs = this.value.split(/\n\s*\n/).filter(p => p.trim().length > 0);
                const paragraphNum = paragraphs.length;
                paragraphCount.textContent = `문단수: ${paragraphNum}개`;

                // 문단 분석 업데이트
                updateParagraphAnalysis(paragraphs);
            });

            // 초기 상태 설정
            triggerInitialAnalysis();
        });

        // 문단 분석 업데이트 함수
        function updateParagraphAnalysis(paragraphs) {
            const paragraphAnalysis = document.querySelector('.paragraph-analysis');
            if (!paragraphAnalysis) return;

            const count = paragraphs.length;
            let message = '';

            switch(count) {
                case 0:
                    message = '글을 작성해주세요';
                    break;
                case 1:
                    message = '첫 문단을 작성했네요. 새로운 내용이 시작되면 엔터키를 눌러주세요.';
                    break;
                case 2:
                    message = '좋아요! 두 개의 문단으로 내용을 나누었어요. 더 나눌수도 있나요?';
                    break;
                case 3:
                    message = '문단을 적절히 나누고 있어요. 각 문단의 내용이 서로 달라야 해요.';
                    break;
                case 4:
                case 5:
                    message = '문단 구분이 잘 되어있어요. 각 문단이 자연스럽게 이어지나요?';
                    break;
                default:
                    message = '문단이 너무 많아요. 비슷한 내용은 한 문단으로 모아보세요.';
            }

            paragraphAnalysis.innerHTML = `<span>${message}</span>`;
        }

        // 초기 분석 실행 함수
        function triggerInitialAnalysis() {
            const content = document.getElementById('content');
            if (content && content.value) {
                const event = new Event('input');
                content.dispatchEvent(event);
            }
        }

        // 글자 수 세기 함수 개선
        function countCharacters(text) {
            if (!text) return 0;
            // 줄바꿈은 카운트에서 제외하고 나머지 공백은 포함
            return text.replace(/\n/g, '').length;
        }

         // 문단 나누기 제안 함수
         function analyzeParagraph(text) {
             // 문단을 나누는 기준으로 줄바꿈(\n) 만을 활용하도록 한다.
             let paragraphs = text.split('\n').filter(paragraph => paragraph.trim().length > 0);

             // 문단 수가 1개일 경우 "1문단"으로 평가되도록 수정
             if (paragraphs.length === 1) {
                 return [{
                     type: 'single',
                     content: "문단이 나누어지지 않았습니다. 1개의 문단으로 작성되었습니다."
                 }];
             }

             // 문단 수가 여러 개일 경우 기존 분석 로직 수행
             let suggestions = [];

             paragraphs.forEach((paragraph, index) => {
                 // 문장 수 체크 (3문장 이상인 경우)
                 let sentences = paragraph.match(/[^.!?]+[.!?]+/g) || [];
                 if (sentences.length >= 3) {
                     suggestions.push({
                         type: 'length',
                         index: index + 1,
                         content: paragraph.substring(0, 50) + "...",
                         reason: "이 문단에 문장이 3개 이상 있어요. 새로운 내용이 시작되면 엔터키를 눌러서 나누면 좋겠어요.",
                         position: paragraph.length
                     });
                 }

                 // 접속사로 시작하는 문장 체크
                 let conjunctions = ['하지만', '그러나', '그래서', '따라서', '그리고', '또한'];
                 if (conjunctions.some(conj => paragraph.trim().startsWith(conj))) {
                     suggestions.push({
                         type: 'conjunction',
                         index: index + 1,
                         content: paragraph.substring(0, 50) + "...",
                         reason: `'${paragraph.split(' ')[0]}'(으)로 시작하는 새로운 내용이에요. 윗줄에서 엔터키를 눌러 문단을 나누면 좋아요.`,
                         position: 0
                     });
                 }
             });

             return suggestions;
         }

         // 테스트 케이스
         let inputText = `친구랑 친하게 지내야 하는 이유는 정말 많습니다. 친구랑 놀면 혼자 있는 것보다 훨씬 재미있습니다. 예를 들어, 친구랑 축구를 하면 골을 넣었을 때 더 신나고, 혼자서 축구를 하는 건 좀 심심합니다. 그리고 친구가 있으면 내가 슬프거나 속상할 때 위로해 줄 수 있어서 좋습니다. 친구랑 얘기하다 보면 내가 몰랐던 걸 알게 될 때도 많습니다. 또 친구가 웃긴 이야기를 해 줄 때 정말 많이 웃어서 기분이 좋아집니다. 학교에서도 친구가 있으면 쉬는 시간에 놀 수 있어서 심심하지 않습니다. 그래서 저는 친구랑 친하게 지내는 게 꼭 필요하다고 생각합니다. 그러니까 친구가 많으면 좋습니다.`;

         console.log(analyzeParagraph(inputText));


        // 새로 추가되는 코드
        function toggleParagraphPreview() {
            const content = document.getElementById('content').value;
            const previewContent = document.getElementById('previewContent');

            if (!content.trim()) {
                alert('미리보기할 내용을 먼저 작성해주세요.');
                return;
            }

            if (previewContent.classList.contains('hidden')) {
                const paragraphs = content.split('\n').filter(p => p.trim());
                let previewHTML = '<div class="preview-paragraphs">';

                paragraphs.forEach((paragraph, index) => {
                    previewHTML += `
                        <div class="preview-paragraph">
                            <div class="preview-paragraph-header">
                                ${index + 1}번째 문단
                            </div>
                            <div class="preview-paragraph-content">
                                ${paragraph}
                            </div>
                        </div>
                    `;
                });
                previewHTML += '</div>';

                previewContent.innerHTML = previewHTML;
                previewContent.classList.remove('hidden');
                document.querySelector('.preview-button').innerHTML = 
                    '<span>미리보기 닫기</span><span class="button-icon">✕</span>';
            } else {
                previewContent.classList.add('hidden');
                document.querySelector('.preview-button').innerHTML = 
                    '<span>문단 미리보기</span><span class="button-icon">👁️</span>';
            }
        }

        // 이벤트 리스너 수정
        document.addEventListener('DOMContentLoaded', function() {
            const content = document.getElementById('content');
            if (content) {
                content.addEventListener('input', function() {
                    updateParagraphCount();
                    const charCount = document.querySelector('.char-count');
                    charCount.textContent = `글자수: ${countCharacters(this.value)}자`;

                    // 문단 분석 업데이트
                    const paragraphs = this.value.split('\n').filter(p => p.trim());
                    updateParagraphAnalysis(paragraphs);
                });
            }
        });

        // 평가 항목 데이터 추출 함수
         function extractCategoryData(analysis, category) {
             try {
                 const categoryRegex = new RegExp(`\\[${category}\\]([^]*?)(?=\\[|#|$)`);
                 const categoryText = analysis.match(categoryRegex)?.[1] || '';

                 console.log('Category Text:', categoryText);

                 const gradeMatch = categoryText.match(/등급:\s*([A-F][+]?)/);
                 const evaluationMatch = categoryText.match(/평가:([^]*?)(?=잘된 점:|$)/);
                 const goodPointsMatch = categoryText.match(/잘된 점:\s*([\s\S]*?)(?=개선점:|$)/);
                 const improvementsMatch = categoryText.match(/개선점:\s*([\s\S]*?)(?=(?:\[|\n#|$))/);

                 const result = {
                     grade: gradeMatch ? gradeMatch[1] : 'F',
                     evaluation: evaluationMatch ? evaluationMatch[1].trim() : '',
                     goodPoints: goodPointsMatch ? goodPointsMatch[1].trim() : '',
                     improvements: improvementsMatch ? improvementsMatch[1].trim() : ''
                 };

                 console.log('Extracted Data:', result);
                 return result;

             } catch (error) {
                 console.error(`Error extracting data for ${category}:`, error);
                 return {
                     grade: 'F',
                     evaluation: '',
                     goodPoints: '',
                     improvements: ''
                 };
             }
         }

         function formatStructureContent(content, type = 'default') {
             if (!content || content === 'undefined') {
                 return `
                     <div class="content-section">
                         <p class="text-gray-500">아직 분석되지 않았습니다.</p>
                     </div>
                 `;
             }

             try {
                 switch (type) {
                     case 'current':
                         // 현재 문단 구조를 하나의 박스로 표시
                         return `
                             <div class="content-section">
                                 ${content.split('\n')
                                     .filter(line => line.trim())
                                     .map(line => `<p class="content-line">${line}</p>`)
                                     .join('')}
                             </div>
                         `;

                     case 'improved':
                         // 개선된 문단 구조 표시
                         return `
                             <div class="content-section">
                                 ${content.split('\n')
                                     .filter(line => line.trim())
                                     .map(line => `<p class="content-line">${line}</p>`)
                                     .join('')}
                             </div>
                         `;

                     case 'suggestions':
                         // 구체적 실행 방안 표시
                         return `
                             <div class="content-section">
                                 ${content.split('\n')
                                     .filter(line => line.trim())
                                     .map(line => line.replace(/^[*•-]\s*/, ''))
                                     .map(line => `<p class="content-line">• ${line}</p>`)
                                     .join('')}
                             </div>
                         `;

                     default:
                         return `
                             <div class="content-section">
                                 <p class="content-line">${content}</p>
                             </div>
                         `;
                 }
             } catch (error) {
                 console.error('문단 구조화 오류:', error);
                 return '<div class="text-red-500">문단 구조를 표시하는 중 오류가 발생했습니다.</div>';
             }
         }

        document.addEventListener('DOMContentLoaded', function() {
            const content = document.getElementById('content');
            const charCount = document.querySelector('.char-count');
            const submitBtn = document.getElementById('submitBtn');

            document.addEventListener('DOMContentLoaded', function() {
                const content = document.getElementById('content');
                const charCount = document.querySelector('.char-count');
                const submitBtn = document.getElementById('submitBtn');

                // input 이벤트에서는 글자 수만 카운트
                content.addEventListener('input', function() {
                    const totalCount = countCharacters(this.value);
                    charCount.textContent = `글자수: ${totalCount}자`;
                });

                submitBtn.addEventListener('click', async function() {
                    // submitBtn 클릭 이벤트 처리...
                });
            });

        submitBtn.addEventListener('click', async function() {
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();

    if (!title || !content) {
        alert('제목과 내용을 모두 입력해주세요.');
        return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = '분석중...';

    const essayData = {
        title: title,
        content: content,
        grade: document.getElementById('grade').value.trim(),
        class: document.getElementById('class').value.trim(),
        number: document.getElementById('number').value.trim(),
        name: document.getElementById('name').value.trim()
    };

    // 학생의 글을 문단별로 나누고 번호를 매기는 코드
   const paragraphs = essayData.content.split(/\n+/).filter(p => p.trim());
   const numberedParagraphs = paragraphs.map((p, index) => `[${index + 1}문단]\n${p}`).join('\n\n');

    // 프롬프트를 프론트엔드에서 구성
    const prompt = `아래 제시된 제목과 내용을 초등학교 5학년 학생의 수준에서 자세하게 분석해. 학생이 제안 내용을 보고 쉽게 고칠 수 있도록 제시해주세요. 구체적인 예시를 들어가며 설명해.:

        제목: "${title}"
        내용: "${numberedParagraphs}"

        참고로, 위 내용에서 [n문단]으로 표시된 부분이 학생이 나눈 문단입니다. 이 문단 구분을 그대로 사용하여 분석하고, 문단 구분을 임의로 변경하거나 재해석하지 마세요.


                              평가 시 참고사항:
                              - 문단 구분이 없이 작성된 경우, 구조성 점수는 **반드시 D 이하**로 평가할 것**
                              - 문단 구분이 없는 경우, 완성도 점수도 **최대 C**까지만 부여 가능
                              - 글이 수정본인 경우, 이전 제안사항이 잘 반영되었다면 점수를 높게 책정
                              - 문단 구분이 잘 되어 있고 내용이 통일성을 가진다면 완성도 점수를 상향 조정할 것
                              - 문장이 간결해지고 이해하기 쉬워졌다면 표현성 점수 상향
                              - 문단 간 연결이 자연스러워졌다면 구조성 점수 상향
                              - 논리가 더 탄탄해졌다면 논리성 점수 상향
                              - 전체적인 글의 완성도는 문단 구분 여부(내용에 따라 문단을 구분했는지)를 중요하게 반영할 것

                                                        #전체평가
                                                        총평: [쉽고 자세한 설명으로 300자 이내 평가]

                                                         #평가항목
                                                         논리성, 구조성, 표현성, 완성도를 다음 항목에 맞게 자세하게 평가할 것:

                                                         [논리성] (30%)
                                                         등급: [A+~F]
                                                         평가: [종합적 평가 내용을 자세하고 쉽게 설명]
                                                         잘된 점: [구체적 예시와 함께 설명]
                                                         개선점: [어떻게 하면 더 좋아질수 있는지 구체적으로 설명]

                                                         [구조성] (25%)
                                                         등급: [A+~F]
                                                         평가: [종합적 평가 내용을 자세하고 쉽게 설명]
                                                         잘된 점: [구체적 예시와 함께 설명]
                                                         개선점: [어떻게 하면 더 좋아질수 있는지 구체적으로 설명]

                                                         [표현성] (25%)
                                                         등급: [A+~F]
                                                         평가: [종합적 평가 내용을 자세하고 쉽게 설명]
                                                         잘된 점: [구체적 예시와 함께 설명]
                                                         개선점: [어떻게 하면 더 좋아질수 있는지 구체적으로 설명]

                                                         [완성도] (20%)
                                                         등급: [A+~F]
                                                         평가: [종합적 평가 내용을 자세하고 쉽게 설명]
                                                         잘된 점: [구체적 예시와 함께 설명]
                                                         개선점: [어떻게 하면 더 좋아질수 있는지 구체적으로 설명]

                                                         평가 기준:
                                                    [논리성 평가 기준] - 30%
                                                    - 주장의 명확성: 글의 핵심 주장이 명확한가?
                                                    - 근거의 적절성: 주장을 뒷받침하는 근거가 충분한가?
                                                    - 예시의 구체성: 적절한 예시로 설명하고 있는가?
                                                    - 내용의 일관성: 주장에서 벗어난 내용은 없는가?
                                                    - 논리적 흐름: 문장과 문장이 자연스럽게 이어지는가?
                                                    
                                                    [구조성 평가 기준] - 25%
                                                    - 문단 구분의 적절성: 한 문단에 한 가지 중심 내용을 다루는가?
                                                    - 문단의 길이: 한 문단이 3-5문장으로 구성되어 있는가?
                                                    - 문단 간 연결: 문단과 문단이 자연스럽게 이어지는가?
                                                    - 전체 구조: 시작-중간-끝 구조가 잘 갖춰져 있는가?
                                                    - 내용 배열: 비슷한 내용끼리 잘 묶여 있는가?
                                                    
                                                    [표현성 평가 기준] - 25%
                                                    - 어휘 사용: 초등학생 수준에 맞는 어휘를 사용했는가?
                                                    - 맞춤법: 맞춤법과 띄어쓰기가 정확한가?
                                                    - 문장의 완성도: 주어와 서술어가 잘 갖춰져 있는가?
                                                    - 문장의 다양성: 같은 표현이 반복되지는 않는가?
                                                    - 문장의 자연스러움: 읽기 쉽게 표현되어 있는가?
                                                    
                                                    [완성도 평가 기준] - 20%
                                                    - 전체적 통일성: 글의 처음부터 끝까지 한 주제로 일관되는가?
                                                    - 글의 완결성: 글이 자연스럽게 마무리되는가?
                                                    - 분량의 적절성: 주제를 설명하기에 충분한 분량인가?
                                                    - 독자 고려: 읽는 사람이 이해하기 쉽게 썼는가?,
                                                    
                                                       #제목 분석
                                                       현재 제목: "${essayData.title}"
                                                       등급: [A+~F]  
                                                       분석: 제목에 대해 제목과 내용의 연관성 및 명확성을 고려하여 분석할 것.
                                                       제안: 제목이 부족한 경우에만 위 분석을 바탕으로 2-3개의 대안 제목을 제시할 것.
                                                       [제목 평가 기준]
                                                       - 주제 반영: 글의 주제가 제목에 잘 나타나는가?
                                                       - 내용 연관성: 제목과 내용이 잘 어울리는가?
                                                       - 길이와 표현: 제목의 길이와 표현이 적절한가?,

                                                    #문단분석
                                                    사용자가 작성한 각 문단을 하나씩 분석해주세요. 분석, 잘된 점, 개선점을 아주 자세하고 구체적으로 제시해주세요. 각 문단의 분석은 다음 형식을 따릅니다:

                                                    [1문단]
                                                    원문: [여기에 반드시 원문 전체 포함]
                                                    분석:
                                                    잘된 점:
                                                    개선점:
                                                    표현 개선 제안: 문단 내용에서 고쳐야 할 부분과 함께 그에 대한 구체적인 수정 제안을 하고 이유를 알려줄 것. 제안마다 줄을 바꿔서 2가지 이상 제안할 것. 맞춤법은 제안하지 않음.
                                                    맞춤법 교정: 각 맞춤법 오류를 "[틀린 표현] -> [올바른 표현], [틀린 표현]은 잘못된 표현으로, [올바른 표현]이 맞는 표현입니다." 형식으로 제시할 것. 여러 개의 맞춤법 오류가 있다면 줄바꿈으로 구분하여 제시.

                                                    [2문단]
                                                    원문: [여기에 반드시 원문 전체 포함]
                                                    분석:
                                                    잘된 점:
                                                    개선점:
                                                    표현 개선 제안: 문단 내용에서 고쳐야 할 부분과 함께 그에 대한 구체적인 수정 제안을 하고 이유를 알려줄 것. 제안마다 줄을 바꿔서 2가지 이상 제안할 것. 맞춤법은 제안하지 않음.
                                                    맞춤법 교정: 각 맞춤법 오류를 "[틀린 표현] -> [올바른 표현], [틀린 표현]은 잘못된 표현으로, [올바른 표현]이 맞는 표현입니다." 형식으로 제시할 것. 여러 개의 맞춤법 오류가 있다면 줄바꿈으로 구분하여 제시.

                                                    [이후 작성된 글의 끝까지 모든 문단에 대해 동일한 형식으로 분석 계속]

                                                         #문단 구성 제안
                                                         현재 문단 구조:
                                                         - 학생의 글에서 어떤 내용들을 쓰고 있는지 친절하게 설명해주세요
                                                         - 비슷한 내용끼리 어떻게 묶을 수 있는지 구체적으로 알려주세요
                                                         - 각각의 내용이 글의 어느 부분에 있는지 실제 문장을 예시로 들어주세요

                                                         #문단 구성 제안
                                                         현재 문단 구조:
                                                         - 이 글에서 다루고 있는 주요 내용을 정리해주세요
                                                         - 비슷한 내용끼리 어떻게 묶여있는지 설명해주세요
                                                         - 현재 문단구조에 대해 평가해주세요.

                                                         문단 구성 개선안:
                                                         글의 내용과 길이를 고려했을 때, 총 [3~5]개의 문단으로 나누면 좋을 것 같아요.

                                                         1. 시작하는 문단에서는:
                                                         - 글의 주제를 소개하는 내용: [구체적인 방법 및 내용 제안]
                                                         - 왜 이 주제를 선택했는지 설명: [구체적인 방법 및 내용 제안]
                                                         - 실제 글에서 사용할 문장: "[학생의 글에서 발췌한 문장]"

                                                         2. 중간 문단(들)에서는:
                                                         - [몇 개의 중간 문단이 필요한지, 왜 그렇게 나누면 좋은지 설명]
                                                         - 각 문단별로 다룰 내용: [구체적인 방법 및 내용 제안]
                                                         - 실제 글에서 사용할 문장들: "[학생의 글에서 발췌한 문장들]"

                                                         3. 마무리 문단에서는:
                                                         - 전체 내용 요약 방법: [구체적인 방법 및 내용 제안]
                                                         - 글을 어떻게 마무리하면 좋을지: [구체적인 방법 및 내용 제안]
                                                         - 실제 글에서 사용할 문장: "[학생의 글에서 발췌한 문장]"

                                                         구체적 실행 방안:
                                                         * 글을 크게 [숫자]개의 문단으로 나누어 보세요. 그 이유는: [이유 설명]
                                                         * 각 문단은 이렇게 연결하면 좋아요: [구체적인 연결 방법]
                                                         * 새로운 문단을 시작할 때는 한 줄을 띄우고, '그리고', '하지만'과 같은 연결하는 말로 자연스럽게 이어보세요
                                                         * 한 문단에는 너무 많은 내용을 넣지 말고, 비슷한 내용끼리 모아서 써보세요`;

    try {
        const response = await fetch('/api/analyze', {  // URL 경로 수정
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify({ prompt })
});

        if (!response.ok) {
            throw new Error('API 요청 실패');
        }

        const data = await response.json();
        displayAnalysis(data.choices[0].message.content, essayData);
    } catch (error) {
        console.error('분석 오류:', error);
        alert('분석 중 오류가 발생했습니다. 다시 시도해주세요.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '분석하기';
    }
});
                                    });

                                </script>
                                        </body>
                                        </html>
